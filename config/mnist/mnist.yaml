# @package _global_
# MNIST Federated Class-Incremental Learning Configuration

defaults:
  - _self_

# -------------------------
# Dataset & Data Loading
# -------------------------
dataset:
  name: mnist
  data_root: /home/hli54/data
  num_classes: 10
  img_size: 224  # Resize for ResNet18
  original_img_size: 28  # Original MNIST size (for generator)
  img_channels: 1  # MNIST is grayscale
  classes_per_task: 2
  convert_grayscale_to_rgb: true  # Convert to RGB for ResNet compatibility

# -------------------------
# Federated Learning Setup
# -------------------------
federated:
  num_clients: 5
  clients_per_round: 3
  alpha: 1.0  # Dirichlet concentration for client splits

# -------------------------
# Client Type Selection
# -------------------------
# Options: 
#   - "fedavg_gan": Standard FedAvg with GAN replay (IncrementalNet + conditional GAN)
#   - "acgan": ACGAN-based client (single model for classification and generation)
client:
  type: acgan

# -------------------------
# Training Hyperparameters
# -------------------------
training:
  global_rounds: 10
  local_epochs: 3
  batch_size: 64
  eval_batch_size: 512
  lr: 1e-3
  gan_lr: 2e-4
  weight_decay: 0.0001
  gan_weight_decay: 0.0005
  max_grad_norm: null

# -------------------------
# Model Configuration
# -------------------------
model:
  classification_head_type: multilayer  # singlehead or multilayer
  hidden_dim: 128  # Hidden dimension for multilayer classifier

# -------------------------
# Replay Configuration
# -------------------------
replay:
  ratio: 1.0  # Replay samples per real batch (0..1)

# -------------------------
# Server Optimization
# -------------------------
server:
  opt_steps: 0  # Server-side optimization steps
  opt_lr: 1e-4
  replay_batch: 128  # Synthetic batch size for server steps

# -------------------------
# GAN Configuration
# -------------------------
gan:
  z_dim: 128
  lr: 5e-3
  label_embed_dim: 64
  steps_per_batch: 1
  # Generator produces grayscale 28x28 images (native MNIST)
  # Discriminator sees RGB 224x224 (after transforms)

# -------------------------
# ACGAN Configuration (only used when client.type=acgan)
# -------------------------
acgan:
  z_dim: 128
  img_channels: 1  # MNIST is grayscale
  img_size: 28  # Native MNIST size (ACGAN works on original size)
  base_channels: 64
  g_lr: 2e-4
  d_lr: 2e-4

# -------------------------
# System & Paths
# -------------------------
system:
  seed: 42
  num_workers: 6
  max_concurrent_clients: 5
  cache_dir: /home/hli54/.cache
  cpu: false  # Force CPU execution

# -------------------------
# Logging
# -------------------------
logging:
  log_dir: /home/hli54/scratch/logs/fcil/mnist/
  eval_every: 1  # Rounds between evals (per task)

# -------------------------
# Hydra Configuration
# -------------------------
hydra:
  run:
    dir: ${logging.log_dir}/${now:%Y-%m-%d}/${now:%H-%M-%S}
  sweep:
    dir: ${logging.log_dir}/${now:%Y-%m-%d}/${now:%H-%M-%S}
    subdir: ${hydra.job.num}
  job:
    chdir: false  # Don't change working directory
